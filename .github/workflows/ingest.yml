name: Ingest KB

on:
  workflow_dispatch:
    inputs:
      note:
        description: "Optional note"
        required: false
        default: "Manual KB ingestion"

jobs:
  ingest:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Use Node 20
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Diagnostics (env presence)
        env:
          HAS_OPENAI: ${{ secrets.OPENAI_API_KEY != '' }}
          HAS_POSTGRES: ${{ secrets.POSTGRES_URL != '' }}
          HAS_CLICKUP_TOKEN: ${{ secrets.CLICKUP_API_TOKEN != '' }}
          HAS_CLICKUP_LIST_IDS: ${{ secrets.CLICKUP_LIST_IDS != '' }}
          HAS_CLICKUP_DOC_IDS: ${{ secrets.CLICKUP_DOC_IDS != '' }}
          HAS_CLICKUP_WORKSPACE_ID: ${{ secrets.CLICKUP_WORKSPACE_ID != '' }}
          HAS_CLICKUP_DOC_SHARE_URLS: ${{ secrets.CLICKUP_DOC_SHARE_URLS != '' }}
        run: |
          echo "OPENAI_API_KEY: $HAS_OPENAI"
          echo "POSTGRES_URL: $HAS_POSTGRES"
          echo "CLICKUP_API_TOKEN: $HAS_CLICKUP_TOKEN"
          echo "CLICKUP_LIST_IDS: $HAS_CLICKUP_LIST_IDS"
          echo "CLICKUP_DOC_IDS: $HAS_CLICKUP_DOC_IDS"
          echo "CLICKUP_WORKSPACE_ID: $HAS_CLICKUP_WORKSPACE_ID"
          echo "CLICKUP_DOC_SHARE_URLS: $HAS_CLICKUP_DOC_SHARE_URLS"

      - name: Install deps
        run: npm ci

      - name: Ingest local KB (files)
        if: ${{ !secrets.CLICKUP_API_TOKEN }}
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          POSTGRES_URL: ${{ secrets.POSTGRES_URL }}
        run: npx tsx src/rag/ingest.ts

      - name: Ingest ClickUp KB
        if: ${{ secrets.CLICKUP_API_TOKEN != '' }}
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          POSTGRES_URL: ${{ secrets.POSTGRES_URL }}
          CLICKUP_API_TOKEN: ${{ secrets.CLICKUP_API_TOKEN }}
          CLICKUP_LIST_IDS: ${{ secrets.CLICKUP_LIST_IDS }}
        run: npx tsx src/rag/ingest_clickup.ts

      - name: Ingest ClickUp Docs via API
        if: ${{ secrets.CLICKUP_API_TOKEN != '' && (secrets.CLICKUP_WORKSPACE_ID != '' || secrets.CLICKUP_DOC_IDS != '') }}
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          POSTGRES_URL: ${{ secrets.POSTGRES_URL }}
          CLICKUP_API_TOKEN: ${{ secrets.CLICKUP_API_TOKEN }}
          CLICKUP_WORKSPACE_ID: ${{ secrets.CLICKUP_WORKSPACE_ID }}
          CLICKUP_DOC_IDS: ${{ secrets.CLICKUP_DOC_IDS }}
        run: npx tsx src/rag/ingest_clickup_api_docs.ts

      - name: Ingest ClickUp Docs (public URLs)
        if: ${{ secrets.CLICKUP_DOC_SHARE_URLS != '' }}
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          POSTGRES_URL: ${{ secrets.POSTGRES_URL }}
          CLICKUP_DOC_SHARE_URLS: ${{ secrets.CLICKUP_DOC_SHARE_URLS }}
        run: npx tsx src/rag/ingest_clickup_docs.ts
